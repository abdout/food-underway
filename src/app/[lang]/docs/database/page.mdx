## Database

**Menu** (منيو) uses a multi-tenant architecture with complete data isolation per merchant using `merchantId`. Built on PostgreSQL with Prisma ORM, optimized for Saudi Arabia's restaurant market.

### Core Principles

Our database design ensures scalability, security, and Saudi market compliance:

- **Row-Level Security** – Every business model includes `merchantId` field ensuring complete data isolation
- **Arabic-First Design** – Native Arabic support with proper RTL collation
- **Saudi Compliance** – ZATCA e-invoicing, SFDA nutrition, Municipality requirements
- **WhatsApp Native** – Built-in WhatsApp Business API integration
- **Multi-Branch Support** – Central management for restaurant chains
- **Prayer Time Aware** – Automatic order pausing during prayer times

### Multi-Tenant Architecture

Every business table includes `merchantId` for complete data isolation. Some lookup tables (like modifiers) also denormalize merchantId for query efficiency:

```typescript
// ✅ Correct - Tenant isolated
const orders = await db.order.findMany({
  where: {
    merchantId: session.merchantId,
    status: "PENDING"
  }
})

// ❌ Wrong - Security risk
const orders = await db.order.findMany({
  where: { status: "PENDING" }
})
```

### Core Schema Design

#### Merchant Entity

```prisma
model Merchant {
  id            String   @id @default(cuid())

  // Business identifiers (Saudi)
  name          String   // Business name
  nameAr        String?  // Arabic name
  type          MerchantType @default(RESTAURANT)
  cuisine       String?  // e.g., "Saudi", "Italian", "Coffee"

  // Contact
  phone         String   // 05XXXXXXXX format
  email         String?
  website       String?

  // Location (Saudi format)
  address       String   // العنوان الوطني السعودي
  addressAr     String?
  city          String
  region        String?  // e.g., "Eastern Province"
  country       String   @default("SA")
  latitude      Float?
  longitude     Float?

  // Business Information
  commercialRegister String? // Saudi commercial registration
  vatNumber     String?  // ZATCA VAT number
  municipalityLicense String? // Balady license

  // Operating Hours
  operatingHours Json?   // Flexible schedule

  // Branding
  logo          String?
  coverImage    String?
  primaryColor  String?

  // Subscription
  subscriptionTier String @default("STARTER")
  subscriptionStatus String @default("TRIALING")
  subscriptionEndDate DateTime?

  // Owner
  owner         User     @relation("MerchantOwner")
  ownerId       String

  // Relations
  branches      Branch[]
  menus         Menu[]
  orders        Order[]
  customers     Customer[]
  tables        Table[]
}

enum MerchantType {
  RESTAURANT
  CAFE
  COFFEE_SHOP
  BAKERY
  FAST_FOOD
  FINE_DINING
  CLOUD_KITCHEN
  FOOD_TRUCK
}
```

#### Branch Management

```prisma
model Branch {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation

  name          String
  nameAr        String?

  // Location
  address       String
  addressAr     String?
  city          String?
  phone         String
  latitude      Float?
  longitude     Float?

  // Manager
  managerId     String?

  // Operating hours (branch-specific)
  operatingHours Json?

  // Settings
  isMainBranch  Boolean  @default(false)
  isActive      Boolean  @default(true)

  // Branch-specific entities
  menus         Menu[]
  orders        Order[]
  tables        Table[]
  reservations  Reservation[]
  reviews       Review[]
  dailyStats    DailyStat[]

  @@unique([merchantId, name])
}
```

#### Menu Management

```prisma
model Menu {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  branchId      String?  // Optional branch-specific menu

  name          String
  nameAr        String?
  description   String?
  descriptionAr String?

  isActive      Boolean  @default(true)
  isDefault     Boolean  @default(false)

  // Menu scheduling
  startTime     String?  // e.g., "06:00"
  endTime       String?  // e.g., "11:00"
  availableDays String[] // ["monday", "tuesday", ...]

  categories    Category[]
  items         MenuItem[]

  @@unique([merchantId, name])
}

model Category {
  id            String   @id @default(cuid())
  merchantId    String   // Denormalized for efficiency
  menuId        String

  nameAr        String   // مقبلات، أطباق رئيسية، مشروبات
  nameEn        String?
  descriptionAr String?
  descriptionEn String?

  image         String?
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)

  items         MenuItem[]

  @@unique([menuId, name])
}

model MenuItem {
  id            String   @id @default(cuid())
  merchantId    String   // Denormalized for efficiency
  menuId        String
  categoryId    String?

  // Names (Arabic support)
  name          String
  nameAr        String?
  description   String?
  descriptionAr String?
  sku           String?  // Stock keeping unit

  // Pricing
  price         Float
  discountPrice Float?
  currency      String   @default("SAR")

  // Media
  image         String?
  images        String[]

  // SFDA Nutrition Compliance
  calories      Int?     // Required for SFDA
  protein       Float?   // grams
  carbs         Float?
  fat           Float?
  fiber         Float?
  sodium        Float?   // mg

  // Dietary & Allergens
  isHalal       Boolean  @default(true)
  isVegetarian  Boolean  @default(false)
  isVegan       Boolean  @default(false)
  isGlutenFree  Boolean  @default(false)
  isDairyFree   Boolean  @default(false)
  isNutFree     Boolean  @default(false)
  allergens     String[]

  // Availability
  isAvailable   Boolean  @default(true)
  isFeatured    Boolean  @default(false)
  prepTime      Int?     // Minutes
  sortOrder     Int      @default(0)

  // Inventory
  stockQuantity Int?     // null = unlimited
  lowStockAlert Int?

  // Relations
  modifiers     Modifier[]
  orderItems    OrderItem[]
  stats         MenuItemStat[]
  inventoryLogs InventoryLog[]

  @@unique([merchantId, sku])
}

model Modifier {
  id            String   @id @default(cuid())
  merchantId    String   // Denormalized for efficiency
  menuItemId    String

  name          String
  nameAr        String?

  type          ModifierType @default(SINGLE)
  required      Boolean  @default(false)
  minSelection  Int      @default(0)
  maxSelection  Int      @default(1)
  sortOrder     Int      @default(0)

  options       ModifierOption[]
}

enum ModifierType {
  SINGLE   // Radio buttons (choose one)
  MULTIPLE // Checkboxes (choose multiple)
}
```

#### Order Management

```prisma
model Order {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  branchId      String?  // Branch tracking

  // Order identifiers
  orderNumber   String   // Human-readable: #1234
  type          OrderType
  status        OrderStatus @default(PENDING)

  // Customer
  customerId    String?
  customerName  String?
  customerPhone String?  // 05XXXXXXXX
  customerEmail String?

  // Dine-in details
  tableId       String?
  table         Table?

  // Delivery (Saudi address)
  deliveryAddress String?
  deliveryNotes String?
  deliveryFee   Float    @default(0)
  deliveryTime  DateTime? // Estimated

  // Pickup
  pickupTime    DateTime?

  // Payment
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus @default(PENDING)
  transactionId String?  // Gateway transaction ID

  // Pricing (SAR)
  subtotal      Float
  tax           Float    // 15% VAT
  discount      Float    @default(0)
  discountCode  String?
  tip           Float    @default(0)
  total         Float

  // Items
  items         OrderItem[]

  // Review
  review        Review?

  // Notes
  notes         String?
  kitchenNotes  String?

  // Staff tracking
  cashierId     String?  // Who took the order
  preparerId    String?  // Who prepared

  // Timestamps
  createdAt     DateTime @default(now())
  acceptedAt    DateTime?
  preparingAt   DateTime?
  readyAt       DateTime?
  completedAt   DateTime?
  canceledAt    DateTime?
  cancelReason  String?

  @@unique([merchantId, orderNumber])
}

enum OrderType {
  DINE_IN
  PICKUP
  DELIVERY
}

enum OrderStatus {
  PENDING      // Order received
  CONFIRMED    // Merchant confirmed
  PREPARING    // Kitchen preparing
  READY        // Ready for pickup/serve
  OUT_FOR_DELIVERY
  COMPLETED
  CANCELED
}

enum PaymentMethod {
  CASH
  MADA         // Saudi debit cards
  CREDIT_CARD
  STC_PAY      // Saudi e-wallet
  APPLE_PAY
  SADAD        // Saudi payment system
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIAL_REFUND
}
```

#### Customer & Loyalty

```prisma
model Customer {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation

  // Primary identifier (Saudi phone)
  name          String
  phone         String   // 05XXXXXXXX
  email         String?

  // Preferences
  language      String   @default("ar")
  notes         String?

  // Loyalty
  loyaltyPoints Int      @default(0)
  totalOrders   Int      @default(0)
  totalSpent    Float    @default(0)

  // Relations
  orders        Order[]
  reservations  Reservation[]
  reviews       Review[]
  customerStat  CustomerStat?

  // Timestamps
  firstOrderAt  DateTime?
  lastOrderAt   DateTime?

  @@unique([merchantId, phone])
}

model LoyaltyProgram {
  id            String   @id @default(cuid())
  merchantId    String   @unique

  name          String
  nameAr        String?
  description   String?
  descriptionAr String?

  type          LoyaltyType @default(POINTS)

  // Points configuration
  pointsPerSAR  Float    @default(1)
  pointValue    Float    @default(0.1) // SAR per point

  // Tiers
  tiers         LoyaltyTier[]

  isActive      Boolean  @default(true)
}

enum LoyaltyType {
  POINTS       // Points-based
  STAMPS       // Digital stamp card
  TIERED       // Bronze/Silver/Gold
  CASHBACK     // Percentage cashback
}
```

#### Tables & Reservations

```prisma
model Table {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  branchId      String?  // Branch association

  number        String   // Table number/name
  qrCode        String?  // QR code for table
  capacity      Int      // Number of seats

  floor         Int      @default(1)
  section       TableSection @default(MIXED)
  status        TableStatus @default(AVAILABLE)

  // Visual floor plan
  positionX     Int?
  positionY     Int?

  orders        Order[]
  reservations  Reservation[]

  @@unique([merchantId, branchId, number])
}

enum TableSection {
  FAMILY       // العائلات
  SINGLES      // العزاب
  MIXED
  OUTDOOR
  PRIVATE      // Private room
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  MAINTENANCE
}

model Reservation {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  branchId      String?

  customerId    String?
  customerName  String
  customerPhone String
  customerEmail String?

  tableId       String?
  date          DateTime
  time          String   // "19:00"
  duration      Int      @default(120) // Minutes
  partySize     Int

  status        ReservationStatus @default(PENDING)

  // Special requests
  specialRequests String?
  notes         String?

  // Confirmation
  confirmationCode String?
  confirmedBy   String?
  confirmedAt   DateTime?

  // Timestamps
  seatedAt      DateTime?
  completedAt   DateTime?

  @@unique([merchantId, confirmationCode])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  SEATED
  COMPLETED
  CANCELED
  NO_SHOW
}
```

#### Marketing & Campaigns

```prisma
model Campaign {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation

  name          String
  nameAr        String?
  description   String?
  descriptionAr String?

  type          CampaignType
  status        CampaignStatus @default(DRAFT)

  // Schedule
  startDate     DateTime
  endDate       DateTime

  // Content
  message       String   // SMS/WhatsApp message
  messageAr     String?
  imageUrl      String?

  // Offer details
  offerCode     String?
  discount      Float?
  discountType  DiscountType?

  // Tracking
  sentCount     Int      @default(0)
  openCount     Int      @default(0)
  redeemCount   Int      @default(0)
}

enum CampaignType {
  SMS
  WHATSAPP
  PUSH_NOTIFICATION
  EMAIL
  IN_APP
}

model Coupon {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation

  code          String   // e.g., "SAVE20"

  // Discount
  discount      Float
  discountType  DiscountType

  // Validity
  validFrom     DateTime
  validUntil    DateTime

  // Usage limits
  maxUses       Int?     // null = unlimited
  maxUsesPerCustomer Int @default(1)
  currentUses   Int      @default(0)

  // Conditions
  minOrderAmount Float?
  applicableItems String[] // Menu item IDs

  isActive      Boolean  @default(true)

  @@unique([merchantId, code])
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  BUY_ONE_GET_ONE
  FREE_ITEM
}
```

#### Reviews & Feedback

```prisma
model Review {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  branchId      String?

  orderId       String   @unique // One review per order
  customerId    String?
  customerName  String

  // Ratings (1-5 stars)
  overallRating Int
  foodRating    Int?
  serviceRating Int?
  ambianceRating Int?
  valueRating   Int?

  // Content
  comment       String?
  commentAr     String?

  // Merchant response
  merchantResponse String?
  merchantResponseAr String?
  respondedAt   DateTime?
  respondedBy   String?

  // Moderation
  isPublished   Boolean  @default(true)
  isFlagged     Boolean  @default(false)

  helpfulCount  Int      @default(0)
}
```

#### Analytics & Reporting

```prisma
model DailyStat {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  branchId      String?

  date          DateTime @db.Date

  // Order metrics
  totalOrders   Int      @default(0)
  completedOrders Int    @default(0)
  canceledOrders Int     @default(0)

  // Revenue metrics (SAR)
  totalRevenue  Float    @default(0)
  cashRevenue   Float    @default(0)
  cardRevenue   Float    @default(0)
  onlineRevenue Float    @default(0)

  // Average metrics
  avgOrderValue Float    @default(0)
  avgPrepTime   Int      @default(0) // minutes

  // Customer metrics
  uniqueCustomers Int    @default(0)
  newCustomers  Int      @default(0)
  repeatCustomers Int    @default(0)

  // Item metrics
  totalItemsSold Int     @default(0)
  topSellingItems Json?  // Array of top items

  // Peak hours
  peakHour      Int?     // Hour of day (0-23)
  peakOrders    Int?

  @@unique([merchantId, branchId, date])
}

model MenuItemStat {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  menuItemId    String

  period        StatPeriod
  date          DateTime @db.Date

  // Sales metrics
  quantitySold  Int      @default(0)
  revenue       Float    @default(0)

  // Performance
  viewCount     Int      @default(0)
  orderCount    Int      @default(0)
  conversionRate Float   @default(0)

  // Rating
  avgRating     Float?
  reviewCount   Int      @default(0)

  @@unique([menuItemId, period, date])
}

enum StatPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model CustomerStat {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  customerId    String

  // Lifetime metrics
  totalOrders   Int      @default(0)
  totalSpent    Float    @default(0)
  avgOrderValue Float    @default(0)

  // Frequency
  firstOrderDate DateTime?
  lastOrderDate DateTime?
  daysSinceLastOrder Int?

  // Preferences
  favoriteItems Json?    // Most ordered items
  preferredOrderType String?
  preferredPayment String?

  // Segmentation
  segment       CustomerSegment?
  churnRisk     ChurnRisk?

  @@unique([merchantId, customerId])
}

enum CustomerSegment {
  NEW           // First-time customer
  REGULAR       // 2-5 orders
  LOYAL         // 6-20 orders
  VIP           // 20+ orders
  DORMANT       // No orders in 30+ days
  LOST          // No orders in 90+ days
}

enum ChurnRisk {
  LOW           // Ordered recently
  MEDIUM        // 2-4 weeks ago
  HIGH          // 4-8 weeks ago
  CHURNED       // 8+ weeks ago
}
```

#### Inventory Management

```prisma
model InventoryLog {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation
  menuItemId    String

  type          InventoryLogType
  quantity      Int      // +/- for additions/deductions
  previousQuantity Int
  newQuantity   Int

  reason        String?
  reference     String?  // Order ID, etc.
  performedBy   String?

  createdAt     DateTime @default(now())
}

enum InventoryLogType {
  SALE          // Deducted due to sale
  RESTOCK       // Added through restocking
  ADJUSTMENT    // Manual adjustment
  WASTE         // Loss due to waste/expiry
  TRANSFER      // Transfer between branches
}
```

#### Audit Trail

```prisma
model AuditLog {
  id            String   @id @default(cuid())
  merchantId    String   // Tenant isolation

  userId        String
  userRole      String
  userName      String

  action        AuditAction
  entityType    String   // Model name
  entityId      String   // Entity ID

  oldData       Json?    // Previous state
  newData       Json?    // New state

  ipAddress     String?
  userAgent     String?

  createdAt     DateTime @default(now())
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
  PAYMENT
  REFUND
}
```

### Performance Optimization

#### Critical Indexes

```sql
-- Tenant isolation (most critical)
CREATE INDEX idx_all_tables_merchant_id ON all_tables(merchant_id);

-- Frequent queries
CREATE INDEX idx_orders_status ON orders(merchant_id, status);
CREATE INDEX idx_orders_date ON orders(merchant_id, created_at DESC);
CREATE INDEX idx_customers_phone ON customers(merchant_id, phone);

-- Branch-specific queries
CREATE INDEX idx_orders_branch ON orders(merchant_id, branch_id);
CREATE INDEX idx_tables_branch ON tables(merchant_id, branch_id);

-- Arabic text search
CREATE INDEX idx_menu_items_name_ar ON menu_items USING gin(name_ar gin_trgm_ops);

-- Analytics queries
CREATE INDEX idx_daily_stats ON daily_stats(merchant_id, date DESC);
CREATE INDEX idx_menu_item_stats ON menu_item_stats(menu_item_id, period, date);
```

#### Query Optimization

```typescript
// Efficient menu query with caching
const menu = await db.menu.findFirst({
  where: {
    merchantId,
    isActive: true,
    isDefault: true
  },
  include: {
    categories: {
      where: { isActive: true },
      include: {
        items: {
          where: { isAvailable: true },
          orderBy: { sortOrder: 'asc' }
        }
      },
      orderBy: { sortOrder: 'asc' }
    }
  }
})

// Cache in Redis (1 hour)
await redis.set(`menu:${merchantId}`, JSON.stringify(menu), 'EX', 3600)
```

### Migration Strategy

#### Initial Setup

```bash
# Set Arabic collation
ALTER DATABASE menu_production SET lc_collate = 'ar_SA.UTF-8';

# Enable extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- For Arabic search

# Configure timezone
SET timezone = 'Asia/Riyadh';
```

#### Prisma Commands

```bash
# Development
pnpm prisma generate       # Generate client
pnpm prisma migrate dev    # Create migration
pnpm prisma studio        # Visual editor

# Production
pnpm prisma migrate deploy # Apply migrations
pnpm db:seed              # Seed Saudi demo data
```

### Security Best Practices

#### Tenant Isolation Middleware

```typescript
// middleware/tenant.ts
export async function getMerchantId(req: Request) {
  const session = await auth()

  if (!session?.user?.merchantId) {
    throw new Error('No merchant context')
  }

  // Attach to all queries
  req.merchantId = session.user.merchantId
  return session.user.merchantId
}

// In server actions
export async function createOrder(data: FormData) {
  const session = await auth()
  const merchantId = session?.user?.merchantId

  if (!merchantId) throw new Error('Unauthorized')

  // Always include merchantId in queries
  const order = await db.order.create({
    data: {
      ...validatedData,
      merchantId // CRITICAL for tenant isolation
    }
  })
}
```

#### Row-Level Security Rules

```sql
-- PostgreSQL RLS
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;

CREATE POLICY tenant_isolation ON orders
  FOR ALL
  USING (merchant_id = current_setting('app.merchant_id'));

-- Apply to all business tables
ALTER TABLE menus ENABLE ROW LEVEL SECURITY;
ALTER TABLE menu_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE customers ENABLE ROW LEVEL SECURITY;
```

### Backup & Disaster Recovery

#### Backup Strategy

- **Real-time**: Streaming replication to standby
- **Hourly**: Incremental backups
- **Daily**: Full backup at 2 AM Riyadh time
- **Weekly**: Offsite backup to different region

#### Recovery Targets

- **RTO**: 2 hours maximum downtime
- **RPO**: 15 minutes maximum data loss
- **Availability**: 99.95% uptime SLA

### Multi-Tenant Best Practices

1. **Always include merchantId** in all business model queries
2. **Denormalize merchantId** in frequently queried tables for performance
3. **Use composite unique constraints** with merchantId to ensure uniqueness within tenant
4. **Index merchantId** as the first column in composite indexes
5. **Validate merchantId** in server actions before database operations
6. **Never expose merchantId** in client-side code or URLs
7. **Use session-based tenant context** for all operations
8. **Implement audit logging** for all tenant data modifications

This database architecture provides a robust, Saudi-compliant foundation for the Menu platform with complete multi-tenant isolation and cultural considerations.